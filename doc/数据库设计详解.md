# 数据库设计详解 - 针对视频图片文件管理系统

## 📋 数据库表结构总览

基于您的需求（管理大量视频和图片文件，通过标签快速检索），数据库设计了4个核心表：

1. **files** - 文件信息表（核心）
2. **tags** - 标签定义表
3. **file_tags** - 文件-标签关联表
4. **file_changes** - 文件变更历史表（可选）

## 📁 1. files表 - 文件信息表

### 表结构（Diesel Schema）
```rust
table! {
    files (id) {
        id -> Int4,                    // 主键，自增ID
        file_hash -> Varchar,          // 文件内容哈希（SHA-256）
        path_hash -> Varchar,          // 路径哈希（快速查找用）
        original_path -> Nullable<Text>, // 原始路径（历史记录）
        current_path -> Text,          // 当前路径
        file_name -> Varchar,          // 文件名
        file_size -> Int8,             // 文件大小（字节）
        file_type -> Varchar,          // 文件类型（扩展名或MIME类型）
        created_time -> Timestamp,     // 文件创建时间
        modified_time -> Timestamp,    // 文件修改时间
        last_seen_time -> Timestamp,   // 最后检测时间
        fingerprint_data -> Bytea,     // 二进制指纹数据（元数据）
        is_active -> Bool,             // 是否活跃（软删除标记）
    }
}
```

### 字段详细说明

#### 核心标识字段
| 字段名 | 类型 | 说明 | 针对视频图片的优化 |
|--------|------|------|-------------------|
| **id** | Int4 | 主键，自增ID | 用于快速关联查询 |
| **file_hash** | Varchar | SHA-256文件内容哈希 | **关键字段**：用于识别文件内容是否变化，即使文件移动/重命名也能识别 |
| **path_hash** | Varchar | 路径哈希（MD5或SHA-1） | 快速路径查找，避免全路径字符串比较 |

#### 路径管理字段
| 字段名 | 类型 | 说明 | 针对视频图片的优化 |
|--------|------|------|-------------------|
| **original_path** | Nullable<Text> | 原始路径（首次扫描时的路径） | 记录文件历史位置，便于追踪 |
| **current_path** | Text | 当前路径 | **关键字段**：文件当前实际位置 |
| **file_name** | Varchar | 文件名（不含路径） | 支持文件名搜索 |

#### 文件属性字段
| 字段名 | 类型 | 说明 | 针对视频图片的优化 |
|--------|------|------|-------------------|
| **file_size** | Int8 | 文件大小（字节） | 大文件处理：视频文件通常较大 |
| **file_type** | Varchar | 文件类型 | **重要字段**：区分视频(.mp4,.avi)、图片(.jpg,.png)等 |
| **created_time** | Timestamp | 文件创建时间 | 按时间筛选 |
| **modified_time** | Timestamp | 文件修改时间 | 检测文件是否被编辑 |

#### 系统管理字段
| 字段名 | 类型 | 说明 | 针对视频图片的优化 |
|--------|------|------|-------------------|
| **last_seen_time** | Timestamp | 最后检测时间 | 监控文件是否被删除 |
| **fingerprint_data** | Bytea | 二进制指纹数据 | 存储视频时长、分辨率、图片尺寸等元数据 |
| **is_active** | Bool | 是否活跃 | 软删除标记，文件删除后保留标签信息 |

### 针对视频图片的特殊设计

#### 1. **fingerprint_data字段扩展设计**
```rust
// 视频文件指纹数据结构
struct VideoFingerprint {
    duration_seconds: f64,      // 视频时长（秒）
    width: u32,                 // 视频宽度
    height: u32,                // 视频高度
    codec: String,              // 视频编码
    frame_rate: f64,            // 帧率
    bitrate: u64,               // 比特率
    has_audio: bool,            // 是否有音频
    audio_codec: Option<String>, // 音频编码
}

// 图片文件指纹数据结构
struct ImageFingerprint {
    width: u32,                 // 图片宽度
    height: u32,                // 图片高度
    color_depth: u8,            // 色彩深度
    dpi_x: Option<f64>,         // X方向DPI
    dpi_y: Option<f64>,         // Y方向DPI
    color_space: Option<String>, // 色彩空间
    has_exif: bool,             // 是否有EXIF信息
}
```

#### 2. **file_type字段分类**
```sql
-- 常见文件类型分类
视频文件: mp4, avi, mkv, mov, wmv, flv, webm, m4v
图片文件: jpg, jpeg, png, gif, bmp, tiff, webp, raw
文档文件: pdf, doc, docx, txt, md
音频文件: mp3, wav, flac, aac, ogg
```

## 🏷️ 2. tags表 - 标签定义表

### 表结构
```rust
table! {
    tags (id) {
        id -> Int4,                    // 主键，自增ID
        name -> Varchar,               // 标签名称（唯一）
        color -> Nullable<Varchar>,    // 标签颜色（十六进制）
        icon -> Nullable<Varchar>,     // 标签图标
        parent_id -> Nullable<Int4>,   // 父标签ID（支持层级标签）
        description -> Nullable<Text>, // 标签描述
        created_time -> Timestamp,     // 创建时间
        usage_count -> Int4,           // 使用次数统计
    }
}
```

### 字段详细说明

#### 标签基本信息
| 字段名 | 类型 | 说明 | 针对视频图片的优化 |
|--------|------|------|-------------------|
| **id** | Int4 | 主键，自增ID | 关联用 |
| **name** | Varchar | 标签名称（唯一） | **关键字段**：标签搜索和显示 |
| **color** | Nullable<Varchar> | 标签颜色（如#FF0000） | 可视化区分不同类型的标签 |
| **icon** | Nullable<Varchar> | 标签图标 | 增强可视化效果 |

#### 标签组织结构
| 字段名 | 类型 | 说明 | 针对视频图片的优化 |
|--------|------|------|-------------------|
| **parent_id** | Nullable<Int4> | 父标签ID | **重要字段**：支持层级标签，如"旅行/2024/日本" |
| **description** | Nullable<Text> | 标签描述 | 说明标签用途 |

#### 统计信息
| 字段名 | 类型 | 说明 | 针对视频图片的优化 |
|--------|------|------|-------------------|
| **created_time** | Timestamp | 创建时间 | 标签管理 |
| **usage_count** | Int4 | 使用次数统计 | **重要字段**：显示热门标签，智能推荐 |

### 针对视频图片的标签分类建议

#### 1. **内容分类标签**
```sql
-- 视频内容标签
INSERT INTO tags (name, color, description) VALUES
('旅行视频', '#4CAF50', '旅行相关视频'),
('家庭视频', '#2196F3', '家庭活动视频'),
('工作视频', '#FF9800', '工作相关视频'),
('教程视频', '#9C27B0', '教学教程视频'),
('娱乐视频', '#F44336', '娱乐休闲视频');

-- 图片内容标签
INSERT INTO tags (name, color, description) VALUES
('风景图片', '#4CAF50', '自然风景图片'),
('人物图片', '#2196F3', '人物肖像图片'),
('美食图片', '#FF9800', '美食摄影图片'),
('建筑图片', '#9C27B0', '建筑摄影图片'),
('动物图片', '#F44336', '动物摄影图片');
```

#### 2. **属性标签**
```sql
-- 视频属性标签
INSERT INTO tags (name, color, description) VALUES
('高清视频', '#00BCD4', '1080p及以上分辨率'),
('4K视频', '#673AB7', '4K超高清视频'),
('长视频', '#FF5722', '时长超过10分钟'),
('短视频', '#795548', '时长少于1分钟'),
('带字幕', '#607D8B', '包含字幕的视频');

-- 图片属性标签
INSERT INTO tags (name, color, description) VALUES
('高清图片', '#00BCD4', '高分辨率图片'),
('手机拍摄', '#673AB7', '手机拍摄的图片'),
('专业摄影', '#FF5722', '专业相机拍摄'),
('修图完成', '#795548', '已经后期处理的图片'),
('原始文件', '#607D8B', '未经处理的原始文件');
```

#### 3. **时间地点标签**
```sql
-- 时间标签（层级结构）
INSERT INTO tags (name, parent_id, color) VALUES
('2024年', NULL, '#3F51B5'),
('2024年1月', 1, '#3F51B5'),
('2024年2月', 1, '#3F51B5'),
('2024年夏季', 1, '#3F51B5');

-- 地点标签（层级结构）
INSERT INTO tags (name, parent_id, color) VALUES
('日本', NULL, '#E91E63'),
('东京', 5, '#E91E63'),
('大阪', 5, '#E91E63'),
('京都', 5, '#E91E63');
```

## 🔗 3. file_tags表 - 文件-标签关联表

### 表结构
```rust
table! {
    file_tags (file_id, tag_id) {
        file_id -> Int4,               // 文件ID（外键）
        tag_id -> Int4,                // 标签ID（外键）
        added_time -> Timestamp,       // 添加时间
        added_by -> Nullable<Varchar>, // 添加者
        confidence -> Float4,          // 关联置信度（0.0-1.0）
    }
}
```

### 字段详细说明

| 字段名 | 类型 | 说明 | 针对视频图片的优化 |
|--------|------|------|-------------------|
| **file_id** | Int4 | 文件ID（外键） | 关联files表 |
| **tag_id** | Int4 | 标签ID（外键） | 关联tags表 |
| **added_time** | Timestamp | 添加时间 | 记录标签添加时间，可按时间筛选 |
| **added_by** | Nullable<Varchar> | 添加者 | 记录谁添加的标签 |
| **confidence** | Float4 | 关联置信度 | **重要字段**：表示标签与文件的关联强度，可用于智能推荐 |

### 复合主键设计
- **主键**：`(file_id, tag_id)` 复合主键
- **优点**：
  1. 确保同一个文件不会重复添加相同标签
  2. 提高关联查询性能
  3. 自然支持多对多关系

### 置信度字段的用途
```sql
-- 置信度示例
confidence = 1.0   -- 用户手动添加的标签（最高置信度）
confidence = 0.8   -- 智能推荐的标签，用户确认
confidence = 0.5   -- 自动识别的标签（如通过文件名分析）
confidence = 0.3   -- 弱关联标签（如通过相似文件推荐）

-- 查询时可根据置信度筛选
SELECT * FROM file_tags WHERE confidence >= 0.7;  -- 只显示高置信度标签
```

## 📊 4. file_changes表 - 文件变更历史表（可选）

### 表结构
```rust
table! {
    file_changes (id) {
        id -> Int4,                    // 主键，自增ID
        file_id -> Int4,               // 文件ID（外键）
        change_type -> Varchar,        // 变更类型
        old_path -> Nullable<Text>,    // 旧路径
        new_path -> Nullable<Text>,    // 新路径
        old_hash -> Nullable<Varchar>, // 旧哈希
        new_hash -> Nullable<Varchar>, // 新哈希
        change_time -> Timestamp,      // 变更发生时间
        detected_time -> Timestamp,    // 检测到变更的时间
    }
}
```

### 字段详细说明

| 字段名 | 类型 | 说明 | 针对视频图片的优化 |
|--------|------|------|-------------------|
| **id** | Int4 | 主键，自增ID | 变更记录ID |
| **file_id** | Int4 | 文件ID（外键） | 关联files表 |
| **change_type** | Varchar | 变更类型 | MOVE, RENAME, MODIFY, DELETE |
| **old_path** | Nullable<Text> | 旧路径 | 文件移动前的路径 |
| **new_path** | Nullable<Text> | 新路径 | 文件移动后的路径 |
| **old_hash** | Nullable<Varchar> | 旧哈希 | 修改前的文件哈希 |
| **new_hash** | Nullable<Varchar> | 新哈希 | 修改后的文件哈希 |
| **change_time** | Timestamp | 变更发生时间 | 文件系统记录的变更时间 |
| **detected_time** | Timestamp | 检测到变更的时间 | 系统检测到变更的时间 |

### 变更类型说明
```sql
-- 变更类型分类
'MOVE'           -- 文件移动（路径变化，内容不变）
'RENAME'         -- 文件重命名（文件名变化，路径可能变化）
'MODIFY'         -- 文件修改（内容变化，路径不变）
'DELETE'         -- 文件删除
'MOVED_AND_MODIFIED' -- 文件移动并修改
'RESTORED'       -- 文件恢复
```

## 🔗 表关联关系

### 1. 核心关联
```
files (1) ──── (n) file_tags (n) ──── (1) tags
    │
    └─── (1) file_changes (n)
```

### 2. 外键约束
```sql
-- file_tags表的外键约束
ALTER TABLE file_tags
ADD CONSTRAINT fk_file_tags_files
FOREIGN KEY (file_id) REFERENCES files(id)
ON DELETE CASCADE;

ALTER TABLE file_tags
ADD CONSTRAINT fk_file_tags_tags
FOREIGN KEY (tag_id) REFERENCES tags(id)
ON DELETE CASCADE;

-- file_changes表的外键约束
ALTER TABLE file_changes
ADD CONSTRAINT fk_file_changes_files
FOREIGN KEY (file_id) REFERENCES files(id)
ON DELETE CASCADE;
```

### 3. 级联删除策略
- **files表删除** → **file_tags表** 对应记录自动删除
- **files表删除** → **file_changes表** 对应记录自动删除
- **tags表删除** → **file_tags表** 对应记录自动删除

## 🎯 针对视频图片文件的优化设计

### 1. 扩展元数据存储
```rust
// 扩展files表，添加视频图片专用字段
table! {
    files_extended (id) {
        id -> Int4,                    // 与files表id一致
        video_duration -> Nullable<Int8>, // 视频时长（毫秒）
        video_width -> Nullable<Int4>,    // 视频宽度
        video_height -> Nullable<Int4>,   // 视频高度
        video_codec -> Nullable<Varchar>, // 视频编码
        image_width -> Nullable<Int4>,    // 图片宽度
        image_height -> Nullable<Int4>,   // 图片高度
        image_dpi_x -> Nullable<Float4>,  // 图片X方向DPI
        image_dpi_y -> Nullable<Float4>,  // 图片Y方向DPI
        has_exif -> Nullable<Bool>,       // 是否有EXIF信息
        exif_data -> Nullable<Jsonb>,     // EXIF数据（JSON格式）
    }
}
```

### 2. 智能标签推荐表
```rust
// 智能标签推荐记录
table! {
    tag_suggestions (id) {
        id -> Int4,                    // 主键
        file_id -> Int4,               // 文件ID
        suggested_tag_id -> Int4,      // 推荐的标签ID
        reason -> Varchar,             // 推荐理由
        confidence -> Float4,          // 推荐置信度
        suggested_time -> Timestamp,   // 推荐时间
        accepted -> Nullable<Bool>,    // 用户是否接受
        accepted_time -> Nullable<Timestamp>, // 接受时间
    }
}
```

### 3. 文件相似度表（用于智能推荐）
```rust
// 文件相似度记录
table! {
    file_similarities (file_id_1, file_id_2) {
        file_id_1 -> Int4,             // 文件1 ID
        file_id_2 -> Int4,             // 文件2 ID
        similarity_score -> Float4,    // 相似度分数（0.0-1.0）
        similarity_type -> Varchar,    // 相似度类型：CONTENT, METADATA, TAG
        calculated_time -> Timestamp,  // 计算时间
    }
}
```

## 📈 索引优化策略

### 1. 核心查询索引
```sql
-- files表索引
CREATE INDEX idx_files_file_hash ON files USING hash(file_hash);
CREATE INDEX idx_files_path_hash ON files USING hash(path_hash);
CREATE INDEX idx_files_current_path ON files USING gin(current_path gin_trgm_ops);
CREATE INDEX idx_files_file_type ON files(file_type);
CREATE INDEX idx_files_is_active ON files(is_active) WHERE is_active = true;
CREATE INDEX idx_files_modified_time ON files(modified_time DESC);

-- tags表索引
CREATE INDEX idx_tags_name ON tags USING gin(name gin_trgm_ops);
CREATE INDEX idx_tags_parent_id ON tags(parent_id);
CREATE INDEX idx_tags_usage_count ON tags(usage_count DESC);

-- file_tags表索引
CREATE INDEX idx_file_tags_file_id ON file_tags(file_id);
CREATE INDEX idx_file_tags_tag_id ON file_tags(tag_id);
CREATE INDEX idx_file_tags_confidence ON file_tags(confidence DESC);
```

### 2. 复合索引（针对常见查询）
```sql
-- 按文件类型和修改时间查询
CREATE INDEX idx_files_type_modified ON files(file_type, modified_time DESC);

-- 按标签和置信度查询
CREATE INDEX idx_file_tags_tag_confidence ON file_tags(tag_id, confidence DESC);

-- 按文件大小和类型查询（针对大视频文件）
CREATE INDEX idx_files_size_type ON files(file_size DESC, file_type) WHERE file_size > 100000000; -- 大于100MB的文件
```

## 🔍 典型查询示例

### 1. 按标签搜索视频文件
```sql
-- 搜索带有"旅行视频"和"日本"标签的所有视频文件
SELECT f.*
FROM files f
JOIN file_tags ft1 ON f.id = ft1.file_id
JOIN tags t1 ON ft1.tag_id = t1.id AND t1.name = '旅行视频'
JOIN file_tags ft2 ON f.id = ft2.file_id
JOIN tags t2 ON ft2.tag_id = t2.id AND t2.name = '日本'
WHERE f.file_type IN ('mp4', 'avi', 'mkv', 'mov')
  AND f.is_active = true
  AND ft1.confidence >= 0.7
  AND ft2.confidence >= 0.7;
```

### 2. 按时间范围搜索图片
```sql
-- 搜索2024年1月拍摄的所有图片
SELECT f.*
FROM files f
JOIN file_tags ft ON f.id = ft.file_id
JOIN tags t ON ft.tag_id = t.id
WHERE f.file_type IN ('jpg', 'jpeg', 'png', 'gif')
  AND f.is_active = true
  AND t.name = '2024年1月'
  AND ft.confidence >= 0.8
ORDER BY f.modified_time DESC;
```

### 3. 智能推荐相关文件
```sql
-- 根据当前文件的标签推荐相似文件
SELECT DISTINCT f2.*,
       COUNT(DISTINCT ft2.tag_id) as common_tags_count
FROM files f1
JOIN file_tags ft1 ON f1.id = ft1.file_id
JOIN file_tags ft2 ON ft1.tag_id = ft2.tag_id AND ft1.file_id != ft2.file_id
JOIN files f2 ON ft2.file_id = f2.id
WHERE f1.id = :current_file_id
  AND f1.is_active = true
  AND f2.is_active = true
  AND ft1.confidence >= 0.7
  AND ft2.confidence >= 0.7
GROUP BY f2.id
ORDER BY common_tags_count DESC, f2.modified_time DESC
LIMIT 10;
```

## 🚀 性能优化建议

### 1. 分区表（针对超大数据量）
```sql
-- 按文件类型分区
CREATE TABLE files_partitioned (LIKE files INCLUDING ALL) PARTITION BY LIST(file_type);

-- 视频分区
CREATE TABLE files_video PARTITION OF files_partitioned FOR VALUES IN ('mp4', 'avi', 'mkv', 'mov', 'wmv');

-- 图片分区
CREATE TABLE files_image PARTITION OF files_partitioned FOR VALUES IN ('jpg', 'jpeg', 'png', 'gif', 'bmp');

-- 其他文件分区
CREATE TABLE files_other PARTITION OF files_partitioned DEFAULT;
```

### 2. 物化视图（加速复杂查询）
```sql
-- 文件标签汇总视图
CREATE MATERIALIZED VIEW mv_file_tags_summary AS
SELECT
    f.id as file_id,
    f.file_name,
    f.file_type,
    f.file_size,
    f.modified_time,
    array_agg(t.name) as tags,
    array_agg(t.color) as tag_colors,
    array_agg(ft.confidence) as tag_confidences
FROM files f
LEFT JOIN file_tags ft ON f.id = ft.file_id
LEFT JOIN tags t ON ft.tag_id = t.id
WHERE f.is_active = true
  AND ft.confidence >= 0.5
GROUP BY f.id, f.file_name, f.file_type, f.file_size, f.modified_time;

-- 创建唯一索引
CREATE UNIQUE INDEX idx_mv_file_tags_summary ON mv_file_tags_summary(file_id);

-- 定时刷新（每天凌晨）
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_file_tags_summary;
```

## 📝 总结

这个数据库设计专门针对您的视频图片文件管理需求进行了优化：

### 核心优势
1. **文件识别**：通过文件哈希确保即使文件移动/重命名也能正确识别
2. **标签系统**：支持层级标签、颜色标记、置信度评分
3. **性能优化**：针对视频图片文件的特殊查询进行了索引优化
4. **扩展性**：预留了元数据扩展字段，支持视频时长、分辨率等专业属性

### 针对您需求的特别设计
1. **大文件处理**：`file_size`字段支持大视频文件
2. **文件类型分类**：专门区分视频和图片文件
3. **智能推荐**：通过置信度字段和相似度计算实现智能标签推荐
4. **变更追踪**：完整记录文件移动、修改历史

这个设计能够支持您管理大量视频图片文件，并通过灵活的标签系统实现快速检索。您可以根据实际需求进一步调整字段和索引策略。